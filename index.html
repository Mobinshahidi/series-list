<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Series Finder</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <header class="p-4 border-b border-white/10">
    <div class="max-w-6xl mx-auto flex flex-wrap gap-2 items-center">
      <input id="search" type="text" placeholder="Filter… (title, year, network)"
             class="px-3 py-2 rounded text-black flex-1 min-w-[220px]" />
      <label class="text-sm text-gray-300">Min ★</label>
      <input id="minRating" type="number" min="0" max="10" step="0.1" value="0"
             class="px-3 py-2 rounded text-black w-24" />
      <button id="reload" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded font-semibold">Reload</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <div id="status" class="hidden mb-4 text-sm text-gray-300"></div>
    <div id="seriesList" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
  </main>

  <template id="card">
    <article class="bg-gray-800 rounded overflow-hidden flex flex-col">
      <div class="aspect-[2/3] bg-gray-700">
        <img data-poster class="w-full h-full object-cover" loading="lazy" alt="Poster"/>
      </div>
      <div class="p-3 flex-1 flex flex-col">
        <h2 data-title class="text-lg font-bold leading-tight"></h2>
        <p data-meta class="text-sm text-gray-300 mt-1"></p>
        <p data-overview class="text-sm text-gray-200 mt-2 line-clamp-3"></p>
        <div class="mt-3 flex gap-2">
          <a data-tmdb target="_blank" class="text-xs px-2 py-1 bg-gray-700 rounded">TMDb</a>
          <a data-imdb target="_blank" class="text-xs px-2 py-1 bg-gray-700 rounded hidden">IMDb</a>
        </div>
      </div>
    </article>
  </template>

  <script>
    const listUrl = '/series.txt';        // your list lives at site root
    let tmdbKey = null;

    const el = (id) => document.getElementById(id);
    const $status = el('status'), $list = el('seriesList'), $card = el('card');

    function setStatus(msg){ $status.textContent = msg; $status.classList.toggle('hidden', !msg); }

    async function loadEnv() {
      // Prefer Netlify function (uses Netlify Environment Variable TMDB_KEY)
      try {
        const r = await fetch('/.netlify/functions/env', { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (j.TMDB_KEY) { tmdbKey = j.TMDB_KEY; return; }
        }
      } catch {}
      // Fallbacks if you ever need them during local testing:
      try { const r = await fetch('env.json', { cache: 'no-store' }); if (r.ok) { const j = await r.json(); if (j.TMDB_KEY) tmdbKey = j.TMDB_KEY; } } catch {}
      if (window.ENV && window.ENV.TMDB_KEY) tmdbKey = window.ENV.TMDB_KEY;
    }

    async function fetchSeriesList() {
      const res = await fetch(listUrl + '?t=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('Cannot load /series.txt');
      const text = await res.text();
      return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }

    function parseHints(raw){
      const lower = raw.toLowerCase();
      const year = (lower.match(/(19|20)\d{2}/)||[])[0];
      let title = lower
        .replace(/\bseries\b/g,'')
        .replace(/\(.*?\)/g,'')
        .replace(/\d{4}(?:\s*-\s*\d{4})?/g,'')
        .replace(/\s+/g,' ').trim();
      if (/clone wars/.test(title)) title = 'star wars: the clone wars';
      return { q: title || raw, year: year ? Number(year) : undefined };
    }

    async function searchTMDB(query, year) {
      // v3 key via api_key param (works with Netlify env var)
      const url = new URL('https://api.themoviedb.org/3/search/tv');
      url.searchParams.set('api_key', tmdbKey);
      url.searchParams.set('query', query);
      url.searchParams.set('include_adult', 'false');
      if (year) url.searchParams.set('first_air_date_year', String(year));

      const res = await fetch(url);
      if (!res.ok) throw new Error('TMDb search failed');
      const data = await res.json();
      return (data.results||[])[0] || null;
    }

    async function fetchDetails(id){
      const url = new URL(`https://api.themoviedb.org/3/tv/${id}`);
      url.searchParams.set('api_key', tmdbKey);
      url.searchParams.set('append_to_response', 'external_ids,networks');
      const r = await fetch(url);
      if (!r.ok) return null;
      return await r.json();
    }

    function renderCard(tv){
      const frag = $card.content.cloneNode(true);
      const img = frag.querySelector('[data-poster]');
      img.src = tv.poster_path ? `https://image.tmdb.org/t/p/w500${tv.poster_path}` : `https://placehold.co/600x900?text=${encodeURIComponent(tv.name||'TV')}`;
      img.alt = tv.name || 'Poster';

      frag.querySelector('[data-title]').textContent = tv.name || tv.original_name || '—';
      const year = tv.first_air_date ? new Date(tv.first_air_date).getFullYear() : '';
      const nets = (tv.networks||[]).map(n=>n.name).join(', ');
      frag.querySelector('[data-meta]').textContent = [year, tv.number_of_seasons ? `${tv.number_of_seasons} seasons` : null, nets||null].filter(Boolean).join(' • ');
      frag.querySelector('[data-overview]').textContent = tv.overview || '—';
      frag.querySelector('[data-tmdb]').href = `https://www.themoviedb.org/tv/${tv.id}`;
      const imdb = tv.external_ids && tv.external_ids.imdb_id;
      if (imdb){
        const a = frag.querySelector('[data-imdb]');
        a.href = `https://www.imdb.com/title/${imdb}/`;
        a.classList.remove('hidden');
      }
      return frag;
    }

    async function reload() {
      if (!tmdbKey) { alert('Missing TMDb key. Define TMDB_KEY in Netlify environment variables.'); return; }
      setStatus('Loading series list…');
      $list.innerHTML = '';
      try {
        const filter = el('search').value.toLowerCase();
        const minRating = parseFloat(el('minRating').value || '0') || 0;
        const titles = await fetchSeriesList();
        setStatus(`Searching TMDb for ${titles.length} titles…`);

        for (const raw of titles) {
          if (filter && !raw.toLowerCase().includes(filter)) continue;
          const { q, year } = parseHints(raw);
          const hit = await searchTMDB(q, year);
          if (!hit) continue;
          // fetch full details (networks, imdb id)
          const details = await fetchDetails(hit.id) || hit;
          if ((details.vote_average||0) < minRating) continue;
          $list.appendChild(renderCard(details));
        }
        setStatus('');
      } catch (e) {
        console.error(e);
        setStatus('Error: ' + e.message);
      }
    }

    document.getElementById('reload').addEventListener('click', reload);

    (async () => {
      await loadEnv();
      await reload();
    })();
  </script>
</body>
</html>

